---
title: "tpm_htseq"
output: html_document
---
```{r}
library(plyr)
```

```{r}
table_htseq <- c("../results/HTSeq/uniquely_mapped/quantification_results_uniquely_mapped.csv")
table_htseq <- read.table(pathogen_table_htseq, sep="\t", stringsAsFactors=F, header = T,row.names = 'gene_id') 
```

```{r}
#
```

```{r}
pathogen_table_salmon <- c("../results/salmon_combined/quantification_annotations_pathogen.csv")
pathogen_table_salmon <- read.table(pathogen_table_salmon, sep="\t", stringsAsFactors=F, header = T) 
```

```{r}
gtf <- rtracklayer::import('../references/salmonella/Salmonella_combined2.gtf')
```

```{r}
common = intersect(rownames(pathogen_table_htseq),gtf$gene_id)

pathogen_table_htseq <- pathogen_table_htseq[common,]

r_gtf <- match(common,gtf$gene_id)

pathogen_table_htseq <- cbind(length = gtf@ranges@width[r_gtf],pathogen_table_htseq)  
```

```{r}
#tpm calculation
tpm <- function(counts, lengths) {
    rate <- counts / lengths
    return(rate / sum(rate) * 1e6)
}
```

```{r}
rename_add_TPM <- function(x) {
  paste(unlist(strsplit(x, "[.]"))[2],"_TPM",sep='')
}

```


```{r}
TPMs <- apply(pathogen_table_htseq[6:dim(pathogen_table_htseq)[2]], 2, function(x) tpm(x, pathogen_table_htseq$length))

colnames(TPMs) <-sapply(colnames(TPMs),function(x) rename_add_TPM(x))
```

```{r}
pathogen_table_htseq <- cbind(pathogen_table_htseq, TPMs, TPM_mean = TPM_mean)
```
